#!/bin/bash
#==============================================================================
# OPTIMISATION KUBUNTU 8.4 - VERSION CORRIGÃ‰E (ZRAM + BUGS RÃ‰SOLUS)
# CORRECTIONS : ZRAM configuration, syntax errors, compatibility
# 7800X3D + 6950XT/7950XT + 32Go RAM + 2.5G NET
#==============================================================================

# --- CONFIGURATION DE SÃ‰CURITÃ‰ ---
set -eo pipefail
trap 'if [ $? -ne 0 ]; then echo -e "\033[0;31m[âœ—] Erreur Ã  la ligne $LINENO lors de la commande : $BASH_COMMAND\033[0m"; fi' ERR

# --- COULEURS ET FONCTIONS ---
RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'; BLUE='\033[0;34m'; CYAN='\033[0;36m'; MAGENTA='\033[0;35m'; NC='\033[0m'
print_status() { echo -e "${BLUE}[INFO]${NC} $1"; }
print_success() { echo -e "${GREEN}[âœ“]${NC} $1"; }
print_warning() { echo -e "${YELLOW}[âš ]${NC} $1"; }
print_highlight() { echo -e "${MAGENTA}[â˜…]${NC} $1"; }
print_section() { echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"; }

# --- DÃ‰TECTION ET VÃ‰RIFICATIONS PRÃ‰ALABLES ---

detect_desktop() {
    if [ -n "${XDG_CURRENT_DESKTOP:-}" ]; then DESKTOP_ENV="$XDG_CURRENT_DESKTOP"
    elif [ -n "${DESKTOP_SESSION:-}" ]; then DESKTOP_SESSION_NAME="$DESKTOP_SESSION"
    elif command -v plasmashell &>/dev/null; then DESKTOP_ENV="KDE"
    else DESKTOP_ENV="Unknown"; fi
    [ -n "${WAYLAND_DISPLAY:-}" ] && SESSION_TYPE="Wayland" || SESSION_TYPE="X11"
}

if [ "$EUID" -ne 0 ]; then echo -e "${RED}Erreur : Ce script doit Ãªtre lancÃ© avec sudo.${NC}"; exit 1; fi
REAL_USER="${SUDO_USER:-$USER}"
REAL_HOME=$(eval echo ~$REAL_USER)

if ! ping -c 1 1.1.1.1 &>/dev/null; then echo -e "${RED}Erreur : Pas de connexion Internet.${NC}"; exit 1; fi

detect_desktop

print_section
echo -e "${CYAN}  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${CYAN}  â•‘   OPTIMISATION KUBUNTU 8.4 - VERSION CORRIGÃ‰E (GAMING PRO)    â•‘${NC}"
echo -e "${CYAN}  â•‘   7800X3D | 6950XT | 32Go@6000MHz | 2.5Gbps | Souris 1000Hz   â•‘${NC}"
echo -e "${CYAN}  â•‘   Bureau : ${DESKTOP_ENV} / ${SESSION_TYPE}                                        â•‘${NC}"
echo -e "${CYAN}  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
print_section

echo -e "${RED}âš ï¸  ATTENTION : CE SCRIPT MODIFIE DES PARAMÃˆTRES SYSTÃˆME CRITIQUES.${NC}"
echo -e "${YELLOW}DÃ©marrage de l'optimisation automatique dans 5 secondes...${NC}"
for i in {5..1}; do echo -n "$i... "; sleep 1; done
echo -e "\n${GREEN}DÃ©marrage !${NC}"

# --- DÃ‰BUT DES SECTIONS D'OPTIMISATION ---

section_1() {
    print_status "1/16 Mise Ã  jour systÃ¨me et prÃ©-requis"
    apt update
    DEBIAN_FRONTEND=noninteractive apt upgrade -y
    DEBIAN_FRONTEND=noninteractive apt full-upgrade -y
    DEBIAN_FRONTEND=noninteractive apt install -y curl wget gnupg ca-certificates gdebi-core build-essential git htop fastfetch software-properties-common apt-transport-https flatpak unattended-upgrades usbutils
    apt install -f -y
    print_success "SystÃ¨me Ã  jour"
}

section_2() {
    print_status "2/16 Pilotes AMD + flags RADV (SÃ©curisÃ©)"
    DEBIAN_FRONTEND=noninteractive apt install -y mesa-vulkan-drivers mesa-utils libgl1-mesa-dri xserver-xorg-video-amdgpu vulkan-tools libvulkan1 mesa-va-drivers mesa-vdpau-drivers
    mkdir -p /etc/environment.d
    cat > /etc/environment.d/amd-gpu.conf <<'EOF'
RADV_PERFTEST=gpl,sam
AMD_VULKAN_ICD=RADV
EOF
    print_success "Pilotes AMD configurÃ©s"
}

section_3() {
    print_status "3/16 CoreCtrl (Stable par dÃ©faut pour Kubuntu)"
    DEBIAN_FRONTEND=noninteractive apt install -y corectrl
    usermod -aG render,video "$REAL_USER"
    print_success "CoreCtrl installÃ© et utilisateur ajoutÃ© aux groupes vidÃ©o/render"
}

section_4() {
    print_status "4/16 MangoHud (HUD performance)"
    DEBIAN_FRONTEND=noninteractive apt install -y mangohud goverlay
    mkdir -p "$REAL_HOME/.config/MangoHud"
    cat > "$REAL_HOME/.config/MangoHud/MangoHud.conf" <<'EOF'
vsync=0
# no_display=1  <-- Mis en commentaire. Le HUD sera VISIBLE par dÃ©faut.
fps
frametime
frame_timing=1
gpu_temp
cpu_temp
gpu_stats
cpu_stats
vram
position=top-left
font_size=24
toggle_hud=Shift_R+F12
toggle_fps_limit=Shift_L+F1
EOF
    chown -R $REAL_USER:$REAL_USER "$REAL_HOME/.config/MangoHud"
    print_success "MangoHud configurÃ© (visible par dÃ©faut)"
}

section_5_apps() {
    print_status "5/16 Installation des applications (Brave, Discord, qBittorrent, VLC)"
    DEBIAN_FRONTEND=noninteractive apt install -y vlc qbittorrent
    print_success "VLC & qBittorrent OK."

    print_status "Installation de Brave Browser..."
    if ! command -v brave-browser &> /dev/null; then
        curl -fsSLo /usr/share/keyrings/brave-browser-archive-keyring.gpg https://brave-browser-apt-release.s3.brave.com/brave-browser-archive-keyring.gpg
        echo "deb [signed-by=/usr/share/keyrings/brave-browser-archive-keyring.gpg] https://brave-browser-apt-release.s3.brave.com/ stable main" > /etc/apt/sources.list.d/brave-browser-release.list
        apt update
        DEBIAN_FRONTEND=noninteractive apt install -y brave-browser
        print_success "Brave Browser installÃ©."
    else
        print_success "Brave est dÃ©jÃ  installÃ©."
    fi

    print_status "Configuration Flatpak et Discord..."
    flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
    set +e
    flatpak install -y flathub com.discordapp.Discord
    if [ $? -eq 0 ]; then print_success "Discord (Flatpak) installÃ©."; else
        print_warning "Discord n'a pas pu Ãªtre installÃ©. Tu pourras l'installer plus tard."
    fi
    set -e
}

section_5_security() {
    print_status "6/16 Renforcement SÃ©curitÃ© (UFW + Fail2ban)"
    DEBIAN_FRONTEND=noninteractive apt install -y ufw
    ufw default deny incoming
    ufw default allow outgoing
    ufw limit ssh
    echo "y" | ufw enable
    print_success "UFW (Pare-feu) activÃ©."

    if systemctl is-active --quiet ssh || systemctl is-active --quiet sshd; then
        print_status "Serveur SSH dÃ©tectÃ©. Installation de Fail2ban..."
        DEBIAN_FRONTEND=noninteractive apt install -y fail2ban
        tee /etc/fail2ban/jail.local <<'EOF'
[DEFAULT]
bantime = 1d
maxretry = 3
[sshd]
enabled = true
port = ssh
EOF
        systemctl enable --now fail2ban
        print_success "Fail2ban activÃ©."
    fi
}

section_5_auto_security() {
    print_status "7/16 Activation des Mises Ã  jour de SÃ‰CURITÃ‰ Automatiques"
    tee /etc/apt/apt.conf.d/20auto-upgrades <<'EOF'
APT::Periodic::Update-Package-Lists "1";
APT::Periodic::Unattended-Upgrade "1";
APT::Periodic::AutocleanInterval "7";
EOF
    tee /etc/apt/apt.conf.d/50unattended-upgrades <<'EOF'
Unattended-Upgrade::Allowed-Origins {
    "${distro_id}:${distro_codename}-security";
};
Unattended-Upgrade::AutoFixInterruptedDpkg "true";
Unattended-Upgrade::MinimalSteps "true";
Unattended-Upgrade::Remove-Unused-Dependencies "true";
Unattended-Upgrade::Automatic-Reboot "false";
EOF
    print_success "Mises Ã  jour SÃ‰CURITÃ‰ auto activÃ©es."
}


section_6() {
    print_status "8/16 GameMode + hugepages (PrioritÃ© corrigÃ©e)"
    DEBIAN_FRONTEND=noninteractive apt install -y gamemode
    mkdir -p /etc/gamemode.d
    cat > /etc/gamemode.d/custom.conf <<'EOF'
[general]
renice=-4
[gpu]
apply_gpu_optimisations=accept-responsibility
gpu_device=0
amd_performance_level=high
[custom]
start=notify-send "GameMode ON" ; echo 128 > /proc/sys/vm/nr_hugepages
end=notify-send "GameMode OFF" ; echo 0 > /proc/sys/vm/nr_hugepages
inhibit_screensaver=1
EOF
    print_success "GameMode configurÃ© (PrioritÃ© HAUTE : renice=-4)."
}

section_7() {
    print_status "9/16 RÃ©seau 2.5 Gbps optimisÃ© (BBR) (Buffers corrigÃ©s)"
    modprobe tcp_bbr 2>/dev/null || true
    echo "tcp_bbr" >> /etc/modules-load.d/modules.conf
    tee /etc/sysctl.d/99-network-gaming.conf <<'EOF'
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr

# Buffers optimisÃ©s pour 2.5 Gbps+ (32Mo)
net.core.rmem_max = 33554432
net.core.wmem_max = 33554432
net.ipv4.tcp_rmem = 4096 87380 33554432
net.ipv4.tcp_wmem = 4096 65536 33554432

# Le reste est OK
net.ipv4.tcp_fastopen = 3
net.core.netdev_max_backlog = 30000
net.core.somaxconn = 2048
EOF
    sysctl --system
    NIC=$(ip route | grep default | awk '{print $5}' | head -n1)
    if [ -n "$NIC" ]; then
        ethtool -G "$NIC" rx 4096 tx 4096 &>/dev/null || true
    fi
    print_success "RÃ©seau optimisÃ© pour 2.5 Gbps."
}

section_10_grub() {
    print_status "10/16 GRUB (Pilote CPU AMD P-State)"
    if [ ! -f /etc/default/grub.backup ]; then
        cp /etc/default/grub /etc/default/grub.backup
    fi
    sed -i 's/^GRUB_CMDLINE_LINUX_DEFAULT=.*/GRUB_CMDLINE_LINUX_DEFAULT="quiet splash amd_pstate=guided"/g' /etc/default/grub
    update-grub
    print_success "GRUB mis Ã  jour (amd_pstate=guided)."
}

section_11_kernel_base() {
    print_status "11/16 Optimisations kernel (Swappiness, Cache)"
    tee /etc/sysctl.d/99-gaming-advanced.conf <<'EOF'
vm.swappiness = 10
vm.page-cluster = 0
vm.vfs_cache_pressure = 50
fs.file-max = 2097152
EOF
    sysctl --system
    print_success "Sysctl (base) appliquÃ©."
}

section_12_zram() {
    print_status "12/16 Configuration ZRAM (Swap en RAM) - CORRIGÃ‰"
    
    # VÃ©rifier si systemd-zram-generator est disponible
    if apt-cache show systemd-zram-generator &>/dev/null; then
        print_status "Installation de systemd-zram-generator..."
        DEBIAN_FRONTEND=noninteractive apt install -y systemd-zram-generator
        
        mkdir -p /etc/systemd
        tee /etc/systemd/zram-generator.conf <<'EOF'
[zram0]
zram-size = 16384
compression-algorithm = lz4
swap-priority = 100
EOF
        # Recharger systemd et gÃ©nÃ©rer zram
        /usr/lib/systemd/systemd-zram-generator /run/systemd/zram-generator.conf || true
        systemctl daemon-reload
        
        # Attendre que le device soit crÃ©Ã©
        sleep 2
        
        # VÃ©rifier et activer zram0
        if [ -e /dev/zram0 ]; then
            mkswap /dev/zram0 2>/dev/null || true
            swapon /dev/zram0 2>/dev/null || true
            print_success "ZRAM activÃ© (16Go, lz4)"
        else
            print_warning "ZRAM device non crÃ©Ã©, passage Ã  zram-tools..."
            DEBIAN_FRONTEND=noninteractive apt install -y zram-tools
            tee /etc/default/zramswap <<'EOF'
ALGO=lz4
PERCENT=50
PRIORITY=100
EOF
            systemctl restart zramswap.service
            systemctl enable zramswap.service
            print_success "ZRAM (zram-tools) activÃ©."
        fi
    else
        # Fallback sur zram-tools
        print_status "Installation de zram-tools..."
        DEBIAN_FRONTEND=noninteractive apt install -y zram-tools
        
        tee /etc/default/zramswap <<'EOF'
ALGO=lz4
PERCENT=50
PRIORITY=100
EOF
        systemctl restart zramswap.service
        systemctl enable zramswap.service
        print_success "ZRAM (zram-tools) activÃ©."
    fi
}

section_13_gaming_mouse() {
    print_status "13/16 ğŸ® Souris Gaming 1000Hz (Polling Rate OptimisÃ©)"
    
    tee /etc/udev/rules.d/50-mouse-gaming.rules <<'EOF'
# Optimisation souris gaming : 1000Hz polling rate
# Force le taux de rafraÃ®chissement USB Ã  1000Hz (1ms) pour toutes les souris
ACTION=="add", SUBSYSTEM=="usb", DRIVER=="usbhid", ATTR{bInterval}=="*", ATTR{bInterval}="1"

# DÃ©sactive l'Ã©conomie d'Ã©nergie USB pour les pÃ©riphÃ©riques HID (souris/clavier)
ACTION=="add", SUBSYSTEM=="usb", ATTR{power/control}="on"
EOF
    udevadm control --reload-rules
    udevadm trigger
    print_success "RÃ¨gles UDEV pour souris 1000Hz appliquÃ©es."
}

section_14_kernel_latency() {
    print_status "14/16 âš¡ RÃ©activitÃ© Noyau Maximale (Low-Latency)"
    
    # Installation du noyau low-latency si disponible
    DEBIAN_FRONTEND=noninteractive apt install -y linux-lowlatency 2>/dev/null || print_warning "Noyau low-latency non disponible, optimisations alternatives appliquÃ©es"
    
    # Optimisations agressives du scheduler pour la rÃ©activitÃ©
    tee /etc/sysctl.d/97-kernel-responsiveness.conf <<'EOF'
# === RÃ‰ACTIVITÃ‰ NOYAU MAXIMALE POUR GAMING (v8.4 CorrigÃ©e) ===

# Scheduler : PrÃ©emption rapide pour rÃ©activitÃ© instantanÃ©e
kernel.sched_latency_ns = 6000000
kernel.sched_min_granularity_ns = 1000000
kernel.sched_wakeup_granularity_ns = 1500000
kernel.sched_migration_cost_ns = 500000
kernel.sched_nr_migrate = 32

# PrioritÃ© temps rÃ©el Ã©tendue (95% pour applications RT)
kernel.sched_rt_runtime_us = 950000
kernel.sched_rt_period_us = 1000000

# RÃ©duction drastique de la latence d'Ã©criture disque (Anti-Saccade)
vm.dirty_background_ratio = 3
vm.dirty_ratio = 10
vm.dirty_writeback_centisecs = 300
vm.dirty_expire_centisecs = 1500

# Latence rÃ©seau ultra-basse (Active Polling)
net.core.busy_poll = 50
net.core.busy_read = 50
net.ipv4.tcp_low_latency = 1

# File d'attente CPU optimisÃ©e (Classique)
kernel.sched_autogroup_enabled = 0
EOF

    # IRQ Balance pour meilleures performances
    DEBIAN_FRONTEND=noninteractive apt install -y irqbalance
    systemctl enable irqbalance
    
    sysctl --system
    
    print_success "RÃ©activitÃ© noyau maximale configurÃ©e (Low-Latency + Anti-Saccade)"
}

section_15_tkl_capslock() {
    print_status "15/16 Configuration Clavier TKL (Verr. Maj = Chiffres)"
    print_warning "Cette section ne fonctionne QUE si vous utilisez la session 'KDE (X11)'."
    print_warning "Elle n'aura AUCUN EFFET sur la session 'Wayland' par dÃ©faut."

    if [ ! -f /usr/share/X11/xkb/symbols/fr.backup ]; then
        cp /usr/share/X11/xkb/symbols/fr /usr/share/X11/xkb/symbols/fr.backup
        print_status "Backup de symbols/fr crÃ©Ã©."
    fi

    mkdir -p /usr/share/X11/xkb/symbols
    cat > /usr/share/X11/xkb/symbols/mswindows-capslock <<'EOF'
partial alphanumeric_keys
xkb_symbols "basic" {
    key <AE01>	{ type= "FOUR_LEVEL_ALPHABETIC", [ ampersand,          1,          bar,   exclamdown ]	};
    key <AE02>	{ type= "FOUR_LEVEL_ALPHABETIC", [    eacute,          2,           at,    oneeighth ]	};
    key <AE03>	{ type= "FOUR_LEVEL_ALPHABETIC", [  quotedbl,          3,   numbersign,     sterling ]	};
    key <AE04>	{ type= "FOUR_LEVEL_ALPHABETIC", [apostrophe,          4,   onequarter,       dollar ]	};
    key <AE05>	{ type= "FOUR_LEVEL_ALPHABETIC", [ parenleft,          5,      onehalf, threeeighths ]	};
    key <AE06>	{ type= "FOUR_LEVEL_ALPHABETIC", [   section,          6,  asciicircum,  fiveeighths ]	};
    key <AE07>	{ type= "FOUR_LEVEL_ALPHABETIC", [    egrave,          7,    braceleft, seveneighths ]	};
    key <AE08>	{ type= "FOUR_LEVEL_ALPHABETIC", [    exclam,          8,  bracketleft,    trademark ]	};
    key <AE09>	{ type= "FOUR_LEVEL_ALPHABETIC", [  ccedilla,          9,    braceleft,    plusminus ]	};
    key <AE10>	{ type= "FOUR_LEVEL_ALPHABETIC", [    agrave,          0,   braceright,       degree ]	};
};
EOF
    print_status "Fichier symbols/mswindows-capslock crÃ©Ã©."

    if grep -q "mswindows-capslock" /usr/share/X11/xkb/symbols/fr; then
        print_success "Modification dÃ©jÃ  prÃ©sente dans symbols/fr."
    else
        sed -i '/include "latin"/a \    include "mswindows-capslock"' /usr/share/X11/xkb/symbols/fr
        print_success "Fichier symbols/fr patchÃ© avec succÃ¨s."
    fi

    rm -rf /var/lib/xkb/*
    print_success "Cache clavier nettoyÃ©."
}

section_16_cleanup() {
    print_status "16/16 Nettoyage final"
    DEBIAN_FRONTEND=noninteractive apt autoremove -y
    apt autoclean -y
    print_success "Nettoyage terminÃ©."
}


# --- EXÃ‰CUTION ---
print_highlight "ExÃ©cution des 16 sections (v8.4 CorrigÃ©e et FinalisÃ©e)..."

section_1
section_2
section_3
section_4
section_5_apps
section_5_security
section_5_auto_security
section_6
section_7
section_10_grub
section_11_kernel_base
section_12_zram
section_13_gaming_mouse
section_14_kernel_latency
section_15_tkl_capslock
section_16_cleanup

print_section
echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${GREEN}â•‘      VERSION 8.4 TERMINÃ‰E â€” SUCCÃˆS TOTAL (BUGS CORRIGÃ‰S)      â•‘${NC}"
echo -e "${GREEN}â•‘  ğŸ® Souris 1000Hz | âš¡ Noyau Low-Latency | ğŸš€ ZRAM Fixed       â•‘${NC}"
echo -e "${GREEN}â•‘  RÃ©activitÃ© maximale + SÃ©curitÃ© renforcÃ©e + StabilitÃ© assurÃ©e â•‘${NC}"
echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
print_section

echo -e "${YELLOW}REBOOT OBLIGATOIRE pour activer toutes les optimisations : ${RED}sudo reboot${NC}"
