#!/bin/bash

# Mettre à jour le système
apt update && apt upgrade -y
apt autoremove -y

# 1. Applications et dépôts
add-apt-repository -y multiverse
apt update
apt install -y ffmpeg flatpak software-properties-common
flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
flatpak install -y org.videolan.VLC org.qbittorrent.qBittorrent com.discordapp.Discord
curl -fsSLo /usr/share/keyrings/brave-browser-archive-keyring.gpg https://brave-browser-apt-release.s3.brave.com/brave-browser-archive-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/brave-browser-archive-keyring.gpg] https://brave-browser-apt-release.s3.brave.com/ stable main" > /etc/apt/sources.list.d/brave-browser-release.list
apt update
apt install -y brave-browser
wget -qO - https://repository.mullvad.net/deb/mullvad-keyring.asc | gpg --dearmor > /usr/share/keyrings/mullvad-archive-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/mullvad-archive-keyring.gpg arch=$( dpkg --print-architecture )] https://repository.mullvad.net/deb/stable $(lsb_release -cs) main" > /etc/apt/sources.list.d/mullvad.list
apt update
apt install -y mullvad-vpn

# 2. Mises à jour automatiques de sécurité
apt install -y unattended-upgrades
echo 'Unattended-Upgrade::Allowed-Origins {
        "${distro_id}:${distro_codename}-security";
};
Unattended-Upgrade::AutoFixInterruptedDpkg "true";
Unattended-Upgrade::MinimalSteps "true";
Unattended-Upgrade::Remove-Unused-Dependencies "true";
Unattended-Upgrade::Automatic-Reboot "false";' > /etc/apt/apt.conf.d/50unattended-upgrades
echo 'APT::Periodic::Update-Package-Lists "1";
APT::Periodic::Download-Upgradeable-Packages "1";
APT::Periodic::AutocleanInterval "7";
APT::Periodic::Unattended-Upgrade "1";' > /etc/apt/apt.conf.d/20auto-upgrades

# 3. Pare-feu
apt install -y ufw gufw
ufw --force enable
ufw default deny incoming
ufw default allow outgoing
ufw deny 22/tcp
ufw deny 5353/udp
ufw deny 137:138/udp
ufw deny 139,445/tcp

# 4. Désactiver services
systemctl --now disable avahi-daemon avahi-daemon.socket
systemctl --now disable cups cups-browsed cups.socket
systemctl --now disable bluetooth
systemctl mask avahi-daemon cups bluetooth

# 5. Fail2ban
apt install -y fail2ban
cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
echo '[DEFAULT]
bantime = 86400
findtime = 600
maxretry = 5
banaction = ufw
[sshd]
enabled = true' > /etc/fail2ban/jail.d/override.conf
systemctl restart fail2ban

# 6. Firmware
apt install -y fwupd
fwupdmgr refresh
fwupdmgr update

# 7. AppArmor (équivalent SELinux)
apt install -y apparmor apparmor-utils apparmor-profiles
systemctl enable apparmor
aa-enforce /etc/apparmor.d/*

# 8. DNS
systemctl enable systemd-resolved
echo '[Resolve]
DNS=1.1.1.1 1.0.0.1
DNSOverTLS=yes
Cache=no
DNSSEC=yes' > /etc/systemd/resolved.conf.d/dns.conf
systemctl restart systemd-resolved

# 9. Kernel
echo 'kernel.yama.ptrace_scope = 1
kernel.kptr_restrict = 2
net.ipv4.tcp_syncookies = 1
net.ipv4.conf.all.accept_redirects = 0
net.ipv6.conf.all.accept_redirects = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.all.accept_source_route = 0
fs.suid_dumpable = 0' > /etc/sysctl.d/99-hardening.conf
sysctl -p /etc/sysctl.d/99-hardening.conf

echo "Terminé. Redémarrage conseillé."
